# Site Configuration Updates

Messages sent with the site-specific configuration values including hours, specifying the blankout video file, and volume settings.

<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [Site Configuration Updates](#site-configuration-updates)
	- [Key/Value Glossary](#keyvalue-glossary)
		- [Fields from GSTV Messages](#fields-from-gstv-messages)
		- [Additional Fields in Invenco Responses](#additional-fields-in-invenco-responses)
	- [Ideal Path](#ideal-path)
		- [What GSTV Sends to Invenco](#what-gstv-sends-to-invenco)
		- [What Invenco Sends to GSTV once Site Configuration Updates have been Validated](#what-invenco-sends-to-gstv-once-site-configuration-updates-have-been-validated)
		- [What Invenco Sends to GSTV once Site Configuration Updates have been Pushed to the Site](#what-invenco-sends-to-gstv-once-site-configuration-updates-have-been-pushed-to-the-site)
		- [What Invenco Sends to GSTV once Blankout Video Associated with the Site Configuration Updates has been Verified at the Site](#what-invenco-sends-to-gstv-once-blankout-video-associated-with-the-site-configuration-updates-has-been-verified-at-the-site)
		- [What Invenco Sends to GSTV once Site Configuration Updates have been Accepted by the Site](#what-invenco-sends-to-gstv-once-site-configuration-updates-have-been-accepted-by-the-site)
	- [Error Path](#error-path)
		- [What Invenco Sends if the Site Configuration Update Notification has Validation Errors](#what-invenco-sends-if-the-site-configuration-update-notification-has-validation-errors)
			- [Specific Examples](#specific-examples)
				- [What Invenco Sends if the openAt or closeAt Time for any Day in the Site Configuration Update Notification is not Formatted Correctly](#what-invenco-sends-if-the-openat-or-closeat-time-for-any-day-in-the-site-configuration-update-notification-is-not-formatted-correctly)
				- [What Invenco Sends if the level for a Volume Object in the Site Configuration Update Notification is not Formatted Correctly](#what-invenco-sends-if-the-level-for-a-volume-object-in-the-site-configuration-update-notification-is-not-formatted-correctly)
				- [What Invenco Sends if the startTime for a Volume Level in the Site Configuration Update Notification is not Formatted Correctly](#what-invenco-sends-if-the-starttime-for-a-volume-level-in-the-site-configuration-update-notification-is-not-formatted-correctly)
				- [What Invenco Sends if the blankoutVideo in the Site Configuration Update Notification does not Contain a File Extension](#what-invenco-sends-if-the-blankoutvideo-in-the-site-configuration-update-notification-does-not-contain-a-file-extension)
				- [What Invenco Sends if the siteId in the Site Configuration Update Notification Does Not Exist](#what-invenco-sends-if-the-siteid-in-the-site-configuration-update-notification-does-not-exist)
				- [What Invenco Sends if the Open At in the Site Configuration Update Notification Is Later than the Close At](#what-invenco-sends-if-the-open-at-in-the-site-configuration-update-notification-is-later-than-the-close-at)
				- [What Invenco Sends if the GUID or updatedOn in the Site Configuration Update Notification Does Not Exist](#what-invenco-sends-if-the-guid-or-updatedon-in-the-site-configuration-update-notification-does-not-exist)
		- [What Invenco Sends if the Blankout Video in the Site Configuration Update Notification is not in the Invenco Library](#what-invenco-sends-if-the-blankout-video-in-the-site-configuration-update-notification-is-not-in-the-invenco-library)
		- [What Invenco Sends if they are Unable to Push Site Configuration Update Notification to Site](#what-invenco-sends-if-they-are-unable-to-push-site-configuration-update-notification-to-site)
		- [What Invenco Sends if a Site Configuration Update Notification is Rejected by the Site](#what-invenco-sends-if-a-site-configuration-update-notification-is-rejected-by-the-site)
	- [Standard Operating Procedure](#standard-operating-procedure)
		- [Applying Configuration Updates](#applying-configuration-updates)
		- [Error Handling](#error-handling)
			- [Default Error Handling](#default-error-handling)
			- [Default Configuration Error Handling](#default-configuration-error-handling)

<!-- /TOC -->

## Key/Value Glossary
### Fields from GSTV Messages
- **guid** - _required_ - A GUID, generated by GSTV, that uniquely identifies this update.  This will be expected in notifications that refer to this update.
- **updatedOn** - _required_ - A UTC date and time that indicates when this update was created. This can be used to ensure updates are applied in the appropriate order. The format will be `YYYY-MM-DD HH:MM:SS:MS` using 24 hour time.
- **configuration** - _required_ - A complete site configuration that should be used to replace the existing configuration.
  - **siteId** - _required_ - Invenco identifier for the site.
  - **hours** - _required_ - Object containing operating hours per day for the site. There will be seven objects - one for each day of the week.
    - **Day of the Week Abreviation** - Array containing multiple openAt and closeAt for the site.
      - **openAt** - _if day of the week array exists this is required_ - The local time the site opens represented as HH:MM using 24 hour time.
      - **closeAt** - _if day of the week array exists this is required_ - The local time the site closes represented as HH:MM using 24 hour time. Times after 24:00 indicates a closing time on the next day. For example, 26:00 should be interpreted as closing at 2:00 AM the following day.
      - **duration** - Length in milliseconds the site is open.
  - **blankoutvideo** - Video file - including file extension - to play continuously when the site is closed. This will override the value configured for the network.
  - **volume** - Array of volume level settings. These will override the values configured for the network.
    - **startTime** - _if volume array exists this is required_ - The local time represented in HH:MM using 24 hour time that the volume setting will take effect.
    - **level** - _if volume array exists this is required_ - The volume level to be set at the site represented as a number between 0 (no audio) and 100 (highest volume setting).

### Additional Fields in Invenco Responses
- **notificationType** - A string indicating the step in the update process to which this notification refers.
  - Values
    - CONFIGURATION_VALIDATION
    - MEDIA_CHECK
    - CONFIGURATION_PUSH_TO_PLAYERS
    - CONFIGURATION_ACCEPTED_BY_PLAYERS
- **notificationTimestamp** - A UTC date and time that indicates when this notification was created. This can be used to ensure notifications are read in the appropriate order. The format will be `year-month-day hours:mins:secs:milliseconds` using 24 hour time.
- **status** - A string that will indicate if the step in the update process for which this notification was generated succeeded or failed.
  - Values
    - success
    - failure
- **id** - A unique identifier for this notification, generated by Invenco, that will be used to refer to the notification in human communication.
- **additionalInformation** - A free-form string that can be a message or other details about the notification. This should be human-readable.

## Ideal Path
### What GSTV Sends to Invenco
```javascript
{
  "guid": String,
  "updatedOn": String,
  "configuration": [
    {
      "siteId": String,
      "hours": {
        "sun": [
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "mon": [
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "tue": [
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "wed": [
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "thu": [
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "fri":[
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ],
        "sat":[
          {
            "openAt": String,
            "closeAt": String,
            "duration": Number
          }
        ]
      },
      "blankoutVideo": String,
      "volume": [
        {
          "startTime": String,
          "level": Number
        },
        {
          "startTime": String,
          "level": Number
        }
      ]
    }
  ]
}
```

### What Invenco Sends to GSTV once Site Configuration Updates have been Validated
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_VALIDATION",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Site Configuration Updates have been Pushed to the Site
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_PUSH_TO_PLAYERS",
  "siteId": String,
  "status": "success"
}
```

### What Invenco Sends to GSTV once Blankout Video Associated with the Site Configuration Updates has been Verified at the Site
```javascript
{
  "guid": String,
  "id": String,
  "filename": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "success"
}
```

### What Invenco Sends to GSTV once Site Configuration Updates have been Accepted by the Site
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_ACCEPTED_BY_PLAYERS",
  "siteId": String,
  "status": "success"
}
```

## Error Path
If any part of a message causes an error the entire update will be rejected.

### What Invenco Sends if the Site Configuration Update Notification has Validation Errors
Follows [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_VALIDATION",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

#### Specific Examples
##### What Invenco Sends if the openAt or closeAt Time for any Day in the Site Configuration Update Notification is not Formatted Correctly
If the openAt or closeAt time is not formatted at HHMM follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Open At Time Incorrectly Formatted for {day}"
```

```javascript
  "additionalInformation": "Close At Time Incorrectly Formatted for {day}"
```

##### What Invenco Sends if the level for a Volume Object in the Site Configuration Update Notification is not Formatted Correctly
If the volume level is not a number between 0 and 100 follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Volume Level Incorrectly Formatted"
```

##### What Invenco Sends if the startTime for a Volume Level in the Site Configuration Update Notification is not Formatted Correctly
If the startTime is not formatted at HHMM follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Volume Start Time Incorrectly Formatted"
```

##### What Invenco Sends if the blankoutVideo in the Site Configuration Update Notification does not Contain a File Extension
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Blankout Video Filename Missing Extension - {filename}"
```

##### What Invenco Sends if the siteId in the Site Configuration Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Site Identifier Does Not Exist"
```

##### What Invenco Sends if the Open At in the Site Configuration Update Notification Is Later than the Close At
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Open At is Later than Close At for {day}"
```

##### What Invenco Sends if the GUID or updatedOn in the Site Configuration Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "GUID is Missing"
```

```javascript
  "additionalInformation": "Updated On is Missing"
```

### What Invenco Sends if the Blankout Video in the Site Configuration Update Notification is not in the Invenco Library
Follow [Default Site Missing File Error Handling](#default-site-missing-error-handling).

### What Invenco Sends if they are Unable to Push Site Configuration Update Notification to Site
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_PUSH_TO_PLAYERS",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

### What Invenco Sends if a Site Configuration Update Notification is Rejected by the Site
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "CONFIGURATION_ACCEPTED_BY_PLAYERS",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

## Standard Operating Procedure
### Applying Configuration Updates
1. Poll for site configuration update notification.
1. Validate site configuration update notification.
  - **If success**
    - **Follow [What Invenco Sends to GSTV once Site Configuration Updates have been Validated](#what-invenco-sends-to-gstv-once-site-configuration-updates-have-been-validated).**
  - **If failure**
      - **Follow [What Invenco Sends if the Site Configuration Update Notification has Validation Errors](#what-invenco-sends-if-the-site-configuration-update-notification-has-validation-errors).**
1. Send site configuration to site.
  - **If success**
    - **Follow [What Invenco Sends to GSTV once Site Configuration Updates have been Pushed to the Site](#what-invenco-sends-to-gstv-once-site-configuration-updates-have-been-pushed-to-the-site).**
  - **If failure**
    - **Follow [What Invenco Sends if they are Unable to Push Site Configuration Update Notification to Site](#what-invenco-sends-if-they-are-unable-to-push-site-configuration-update-notification-to-site).**
1. Verify blankout video associated with site configuration is present at site.
  - **If success**
    - **Follow [What Invenco Sends to GSTV once Blankout Video Associated with the Site Configuration Updates has been Verified at the Site](#what-invenco-sends-to-gstv-once-blankout-video-associated-with-the-site-configuration-updates-has-been-verified-at-the-site ).**
  - **If failure**
    - **Follow [What Invenco Sends if the Blankout Video in the Site Configuration Update Notification is not in the Invenco Library](#what-invenco-sends-if-a-site-configuration-update-notification-is-rejected-by-the-site).**

### Error Handling
#### Default Error Handling
1. Send a notification message to GSTV alerting that an error has occurred.
1. GSTV sends another notification update message.

#### Default Configuration Error Handling
1. Send a notification message to GSTV alerting that an error has occurred.
1. If a previous configuration exists
  1. Continue to operate using previous configuration until next update
1. If no previous configuration exists
  1. Use default initialization configuration until next update
1. GSTV sends another notification update message.
