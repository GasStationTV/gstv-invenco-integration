# Playlist Updates

<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [Playlist Updates](#playlist-updates)
	- [Key/Value Glossary](#keyvalue-glossary)
		- [Field from GSTV Messages](#field-from-gstv-messages)
		- [Additional Fields in Invenco Responses](#additional-fields-in-invenco-responses)
	- [Ideal Path](#ideal-path)
		- [What GSTV Sends to Invenco](#what-gstv-sends-to-invenco)
		- [What Invenco Sends to GSTV once Playlist Updates have been Validated](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-validated)
		- [What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified at the Site](#what-invenco-sends-to-gstv-once-media-files-associated-with-the-playlist-updates-have-been-verified-at-the-site)
		- [What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-pushed-to-the-players)
		- [What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-pushed-to-the-players)
	- [Error Path](#error-path)
		- [What Invenco Sends if the Playlist Update Notification has Validation Errors](#what-invenco-sends-if-the-playlist-update-notification-has-validation-errors)
			- [Specific Examples](#specific-examples)
				- [What Invenco Sends if the updatedOn, filename Extension, date, loopNumber, start or end in the Playlist Update Notification is not Formatted Correctly](#what-invenco-sends-if-the-updatedon-filename-extension-date-loopnumber-start-or-end-in-the-playlist-update-notification-is-not-formatted-correctly)
				- [What Invenco Sends if the guid, updatedOn, playlist, siteId, schedules, segmentId, date, loop, loopNumber, asset, assetId, filename, type, start, end, or tiNumber in the Playlist Updated Notification is Missing](#what-invenco-sends-if-the-guid-updatedon-playlist-siteid-schedules-segmentid-date-loop-loopnumber-asset-assetid-filename-type-start-end-or-tinumber-in-the-playlist-updated-notification-is-missing)
				- [What Invenco Sends if there is a Banner and a Start Date for an Banner Object in the Playlist Update Notification Is After the End Date](#what-invenco-sends-if-there-is-a-banner-and-a-start-date-for-an-banner-object-in-the-playlist-update-notification-is-after-the-end-date)
				- [What Invenco Sends if the Start Date for an Asset in the Playlist Update Notification Is After the End Date](#what-invenco-sends-if-the-start-date-for-an-asset-in-the-playlist-update-notification-is-after-the-end-date)
				- [What Invenco Sends if there is a Daypart and a Start Time for a Daypart Object in the Playlist Update Notification Is After the End Time](#what-invenco-sends-if-there-is-a-daypart-and-a-start-time-for-a-daypart-object-in-the-playlist-update-notification-is-after-the-end-time)
				- [What Invenco Sends if the Banner type in the Site Playlist Update Notification Does Not Exist](#what-invenco-sends-if-the-banner-type-in-the-site-playlist-update-notification-does-not-exist)
				- [What Invenco Sends if the Asset type in the Site Playlist Update Notification Does Not Exist](#what-invenco-sends-if-the-asset-type-in-the-site-playlist-update-notification-does-not-exist)
				- [What Invenco Sends if the siteId in the Playlist Update Notification Does Not Exist](#what-invenco-sends-if-the-siteid-in-the-playlist-update-notification-does-not-exist)
		- [What Invenco Sends if the Video File in the Playlist Update Notification is not in the Invenco Library](#what-invenco-sends-if-the-video-file-in-the-playlist-update-notification-is-not-in-the-invenco-library)
		- [What Invenco Sends if they are Unable to Push Playlist Update Notification to Player](#what-invenco-sends-if-they-are-unable-to-push-playlist-update-notification-to-player)
		- [What Invenco Sends if a Playlist Update Notification is Rejected by the Player](#what-invenco-sends-if-a-playlist-update-notification-is-rejected-by-the-player)
		- [Error Handling](#error-handling)
			- [Playlist Error Handling](#playlist-error-handling)

<!-- /TOC -->

## Key/Value Glossary
### Field from GSTV Messages
- **guid** - _required_ - A GUID, generated by GSTV, that uniquely identifies this update.  This will be expected in notifications that refer to this update.
- **updatedOn** - _required_ - A UTC date and time that indicates when this update was created. This can be used to ensure updates are applied in the appropriate order. The format will be `YYYY-MM-DD HH:MM:SS:MS` using 24 hour time.
- **playlist** - _required_ - Detailed settings for playlist.
  - **siteId** - _required_ - The Invenco name of the site.
  - **banners** - An array containing the information about playing banner static images. If this information is not present, no banners should be displayed.
    - **filename** - _If banners array exists this is required_ - Filename, including file extension, of the image to be displayed.
    - **start** - Date the banner image should begin displaying. The format will be `YYYY-MM-DD`.
    - **end** - Date the banner image should end displaying. The format will be `YYYY-MM-DD`.
    - **type** -  Specifies in which part of the fueling transaction the image should display.
      - Values
        - prefueling
        - postfueling
  - **schedules** - _required_ - Contains the playlist details broken up by date.
    - **segmentId** - _required_ - A unique identifier provided by GSTV for each date of the playlist. We will expect this in notifications related to this date of the playlist.
    - **date** - _required_ - A String that specifies the date the playlist is active.  The format will be `YYYY-MM-DD`.
    - **loops** - _required_ - An array that contains all the loops to be played for the day.
      - **loopNumber** - _required_ - Specifies the order in which this loop should be played in the sequence of loops. Each day will have multiple loops. Each loop should be played sequentially and repeated once the last loop has been played.
      - **assets** - _required_ - An array that specifies all the assets to be played in this loop.
        - **assetId** - _required_ - A string assigned to the media asset by GSTV. This identifier should be included in the ProofofPlay packet coming from Invenco to GSTV.
        - **filename** - _required_ - Filename of the video to be played.
        - **type** - _required_ - The type of video.
          - Values
            - advertising
            - programming
            - brandedMessaging
            - rpa
        - **start** - _required_ - Date the video should begin playing. The format will be `YYYY-MM-DD`.
        - **end** - _required_ - Date the video should end displaying. The format will be `YYYY-MM-DD`.
        - **tiNumber** - This value is internal to GSTV. This value needs to be passed back to GSTV on the ProofofPlayPacket.
        - **dayparts** - An array that specifies specific times of the day that a video should play. If no daypart is present, the video should play without regard to time.
          - **start** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should start playing if a daypart is present.
          - **end** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should stop playing if a daypart is present.

### Additional Fields in Invenco Responses
- **notificationType** - A String indicating the step in the update process to which this notification refers.
  - Values
    - PLAYLIST_VALIDATION
    - MEDIA_CHECK
    - PLAYLIST_PUSH_TO_PLAYERS
    - PLAYLIST_ACCEPTED_BY_PLAYERS
- **notificationTimestamp** - A date and time (in UTC) that indicates when this notification was created. This can be used to ensure notifications are read in the appropriate order. The format will be `year-month-day hours:mins:secs:milliseconds` using 24 hour time.
- **status** - A String that will indicate if the step in the update process for which this notification was generated succeeded or failed.
  - Values
    - success
    - failure
- **id** - A unique identifier for this notification, generated by Invenco, that will be used to refer to the notification in human communication.
- **additionalInformation** - A free-form String that can be a message or other details about the notification.  This should be human-readable.
- **segmentIds** - An array of segment ids from the playlist that are related to this notification.

## Ideal Path
### What GSTV Sends to Invenco
```javascript
{
  "guid": String,
  "updatedOn": String,
  "playlist": [
    {
      "site": String,
      "banners": [
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        },
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        }
      ],
      "schedules": [
        {
          "date": String,
          "loops": [
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    },
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Validated
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified at the Site
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_PUSH_TO_PLAYERS",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_ACCEPTED_BY_PLAYERS",
  "siteId": String,
  "status": "success",
}
```

## Error Path
If any part of a message causes an error the entire update will be rejected.

### What Invenco Sends if the Playlist Update Notification has Validation Errors
Follows [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

#### Specific Examples
##### What Invenco Sends if the updatedOn, filename Extension, date, loopNumber, start or end in the Playlist Update Notification is not Formatted Correctly
For any of these examples follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

If the updatedOn is not formatted as `YYYY-MM-DD HH:MM:SS:MS`.

```javascript
  "additionalInformation": "Updated On is Incorrectly Formatted"
```

If the banner filename is missing an extension.

```javascript
  "additionalInformation": "Banner Filename Missing Extension - {filename}"
```

If the date for a schedule is not formatted as YYYY-MM-DD.

```javascript
  "additionalInformation": "Schedule Date is Incorrectly Formatted"
```

If loopNumber is not a number.

```javascript
  "additionalInformation": "Loop Number is Incorrectly Formatted"
```

If an asset filename is missing an extension.

```javascript
  "additionalInformation": "Asset Filename Missing Extension - {filename}"
```

If the start or end date is not formatted at YYYY-MM-DD.

```javascript
  "additionalInformation": "Start Date is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Date is Incorrectly Formatted for {filename}"
```

If the start or end time is not formatted at HH:MM.

```javascript
  "additionalInformation": "Start Time is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Time is Incorrectly Formatted for {filename}"
```

##### What Invenco Sends if the guid, updatedOn, playlist, siteId, schedules, segmentId, date, loop, loopNumber, asset, assetId, filename, type, start, end, or tiNumber in the Playlist Updated Notification is Missing
For any of these examples follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

If the guid is missing.

```javascript
  "additionalInformation": "GUID is Missing"
```

If updatedOn is missing.

```javascript
  "additionalInformation": "Updated On is Missing"
```

If the playlist array is missing or there is an empty playlist object in the array.

```javascript
  "additionalInformation": "The Playlist Structure is Missing Information"
```

If siteId is missing.

```javascript
  "additionalInformation": "Site Identifier is Missing"
```

If a banner array exists and any object in that array is missing the filename.

```javascript
  "additionalInformation": "Banner Missing Filename"
```

If a banner array exists and any object in that array is missing the type.

```javascript
  "additionalInformation": "Banner Type Missing for {filename}"
```

If a banner array exists and any object in that array is start or end.

```javascript
  "additionalInformation": "Banner Start Date Missing for {filename}"
```

```javascript
  "additionalInformation": "Banner End Date Missing for {filename}"
```

If a banner array exists and any object in that array is missing the start, end or type and the filename.

```javascript
  "additionalInformation": "Banner Structure is Missing Information"
```

If the schedules array is missing or there is an empty schedule object in the array.

```javascript
  "additionalInformation": "Schedule Structure is Missing Information"
```

If segmentId is missing.

```javascript
  "additionalInformation": "Segment ID is Missing"
```

If segment date is missing.

```javascript
  "additionalInformation": "Segment Date is Missing"
```

If the loop array is missing or there is an empty loop object in the array.

```javascript
  "additionalInformation": "Loop Structure is Missing Information"
```

If loopNumber is missing.

```javascript
  "additionalInformation": "Loop Number is Missing"
```

If the asset array is missing or there is an empty asset object in the array.

```javascript
  "additionalInformation": "Asset Structure is Missing Information"
```

If assetId is missing.

```javascript
  "additionalInformation": "Asset {filename} Missing ID"
```

If an asset is missing the filename.

```javascript
  "additionalInformation": "Asset Missing Filename"
```

If an asset is missing the type.

```javascript
  "additionalInformation": "Asset {filename} Missing Type"
```

If an asset is missing the start date.

```javascript
  "additionalInformation": "Asset {filename} Missing Start Date"
```

If an asset is missing the end date.

```javascript
  "additionalInformation": "Asset {filename} Missing End Date"
```

If an asset is missing the assetId, type, start date or end date and the asset is missing a filename.

```javascript
  "additionalInformation": "Asset Missing Information"
```

If a daypart array exists and any object in that array is missing the start.

```javascript
  "additionalInformation": "Asset {filename} Missing Daypart Start Time"
```

If a daypart array exists and any object in that array is missing the end.

```javascript
  "additionalInformation": "Asset {filename} Missing Daypart End Time"
```

If a daypart array exists and any object in that array is missing the start or  end time and the asset is missing a filename.

```javascript
  "additionalInformation": "Asset Missing Daypart Information"
```

##### What Invenco Sends if there is a Banner and a Start Date for an Banner Object in the Playlist Update Notification Is After the End Date
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Start Date is After End Date for Banner - {filename}"
```

##### What Invenco Sends if the Start Date for an Asset in the Playlist Update Notification Is After the End Date
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Start Date is After End Date for {filename}"
```

##### What Invenco Sends if there is a Daypart and a Start Time for a Daypart Object in the Playlist Update Notification Is After the End Time
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Daypart Start Time is After End Time for {filename}"
```

##### What Invenco Sends if the Banner type in the Site Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Banner Type Does Not Exist"
```

##### What Invenco Sends if the Asset type in the Site Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Asset Type Does Not Exist"
```

##### What Invenco Sends if the siteId in the Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Site Identifier Does Not Exist"
```

### What Invenco Sends if the Video File in the Playlist Update Notification is not in the Invenco Library
1. Invenco should retry downloading the file three times.
1. If the download is still unsuccessful follow [Default Configuration Error Handling](#default-configuration-error-handling)..

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "failure",
  "additionalInformation": "Video File is Missing - {filename}",
  "segmentIds": [String]
}
```

### What Invenco Sends if they are Unable to Push Playlist Update Notification to Player
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_PUSH_TO_PLAYERS",
  "siteId": String,
  "status": "failure",
  "additionalInformation": "",
  "segmentIds": [String]
}
```

### What Invenco Sends if a Playlist Update Notification is Rejected by the Player
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_ACCEPTED_BY_PLAYERS",
  "siteId": String,
  "status": "failure",
  "additionalInformation": "",
  "segmentIds": [String]
}
```

### Error Handling
#### Playlist Error Handling
1. Send a notification message to GSTV alerting that an error has occurred.
1. Playback does not stop.
1. GSTV sends another notification update message.
