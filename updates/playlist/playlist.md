# Playlist Updates

<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [Playlist Updates](#playlist-updates)
  - [Key/Value Glossary](#keyvalue-glossary)
    - [Field from GSTV Messages](#field-from-gstv-messages)
  - [Ideal Path](#ideal-path)
    - [What GSTV Sends to Invenco](#what-gstv-sends-to-invenco)
    - [What Invenco Sends to GSTV on a Successful Download](#what-invenco-sends-to-gstv-on-a-successful-download)
    - [What Invenco Sends to GSTV once Playlist Updates have been Applied at a Site](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-applied-at-a-site)
  - [Error Path](#error-path)
    - [What Invenco Sends If Playlist can't be parsed](#what-invenco-sends-if-playlist-cant-be-parsed)
    - [What Invenco Sends If Site in Playlist does not exist](#what-invenco-sends-if-site-in-playlist-does-not-exist)
    - [What Invenco Sends If Media File in Playlist Does Not Exist in Invenco Library](#what-invenco-sends-if-media-file-in-playlist-does-not-exist-in-invenco-library)
    - [Error Handling](#error-handling)
      - [Playlist Error Handling](#playlist-error-handling)

<!-- /TOC -->

## Key/Value Glossary
### Field from GSTV Messages
- **guid** - _required_ - A GUID, generated by GSTV, that uniquely identifies this update.  This will be expected in notifications that refer to this update.
- **updatedOn** - _required_ - A UTC date and time that indicates when this update was created. This can be used to ensure updates are applied in the appropriate order. The format will be `YYYY-MM-DD HH:MM:SS:MS` using 24 hour time.
- **playlist** - _required_ - Detailed settings for playlist.
  - **siteId** - _required_ - The Invenco name of the site.
  - **banners** - An array containing the information about playing banner static images. If this information is not present, no banners should be displayed.
    - **filename** - _If banners array exists this is required_ - Filename, including file extension, of the image to be displayed.
    - **start** - Date the banner image should begin displaying. The format will be `YYYY-MM-DD`.
    - **end** - Date the banner image should end displaying. The format will be `YYYY-MM-DD`.
    - **type** -  Specifies in which part of the fueling transaction the image should display.
      - Values
        - prefueling
        - postfueling
  - **schedules** - _required_ - Contains the playlist details broken up by date.
    - **segmentId** - _required_ - A unique identifier provided by GSTV for each date of the playlist. We will expect this in notifications related to this date of the playlist.
    - **date** - _required_ - A String that specifies the date the playlist is active.  The format will be `YYYY-MM-DD`.
    - **loops** - _required_ - An array that contains all the loops to be played for the day.
      - **loopNumber** - _required_ - Specifies the order in which this loop should be played in the sequence of loops. Each day will have multiple loops. Each loop should be played sequentially and repeated once the last loop has been played.
      - **assets** - _required_ - An array that specifies all the assets to be played in this loop.
        - **assetId** - _required_ - A string assigned to the media asset by GSTV. This identifier should be included in the ProofofPlay packet coming from Invenco to GSTV.
        - **filename** - _required_ - Filename of the video to be played.
        - **type** - _required_ - The type of video.
          - Values
            - advertising
            - programming
            - brandedMessaging
            - rpa
        - **start** - _required_ - Date the video should begin playing. The format will be `YYYY-MM-DD`.
        - **end** - _required_ - Date the video should end displaying. The format will be `YYYY-MM-DD`.
        - **tiNumber** - This value is internal to GSTV. This value needs to be passed back to GSTV on the ProofofPlayPacket.
        - **dayparts** - An array that specifies specific times of the day that a video should play. If no daypart is present, the video should play without regard to time.
          - **start** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should start playing if a daypart is present.
          - **end** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should stop playing if a daypart is present.

### Additional Fields in Invenco Responses
- **notificationType** - A String indicating the step in the update process to which this notification refers.
  - Values
    - PLAYLIST_VALIDATION
    - MEDIA_CHECK
    - PLAYLIST_PUSH_TO_PLAYERS
    - PLAYLIST_ACCEPTED_BY_PLAYERS
- **notificationTimestamp** - A date and time (in UTC) that indicates when this notification was created. This can be used to ensure notifications are read in the appropriate order. The format will be `year-month-day hours:mins:secs:milliseconds` using 24 hour time.
- **status** - A String that will indicate if the step in the update process for which this notification was generated succeeded or failed.
  - Values
    - success
    - failure
- **id** - A unique identifier for this notification, generated by Invenco, that will be used to refer to the notification in human communication.
- **additionalInformation** - A free-form String that can be a message or other details about the notification.  This should be human-readable.
- **segmentIds** - An array of segment ids from the playlist that are related to this notification.

## Ideal Path
### What GSTV Sends to Invenco
```javascript
{
  "guid": String,
  "updatedOn": String,
  "playlist": [
    {
      "site": String,
      "banners": [
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        },
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        }
      ],
      "schedules": [
        {
          "date": String,
          "loops": [
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    },
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "segmentId": String,
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Validated
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified at the Site
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_PUSH_TO_PLAYERS",
  "siteId": String,
  "status": "success",
}
```

### What Invenco Sends to GSTV once Playlist Updates have been Pushed to the Players
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_ACCEPTED_BY_PLAYERS",
  "siteId": String,
  "status": "success",
}
```

## Error Path
If any part of a message causes an error the entire update will be rejected.

### What Invenco Sends if the Playlist Update Notification has Validation Errors
Follows [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

#### Specific Examples
##### What Invenco Sends if the updatedOn, filename Extension, date, loopNumber, start or end in the Playlist Update Notification is not Formatted Correctly
If the updatedOn is not formatted as `YYYY-MM-DD HH:MM:SS:MS` follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Updated On is Incorrectly Formatted"
```

If the banner filename is missing an extension follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Banner Filename Missing Extension - {filename}"
```

If the date for a schedule is not formatted as YYYY-MM-DD follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Schedule Date is Incorrectly Formatted"
```

If loopNumber is not a number follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Loop Number is Incorrectly Formatted"
```

If an asset filename is missing an extension follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Asset Filename Missing Extension - {filename}"
```

If the start or end date is not formatted at YYYY-MM-DD follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Start Date is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Date is Incorrectly Formatted for {filename}"
```

If the start or end time is not formatted at HH:MM follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Start Time is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Time is Incorrectly Formatted for {filename}"
```
