# GSTV Initiated Message - Playlist Updates

## Key/Value Glossary
### Field from GSTV Messages
- **guid** - _required_ - A GUID, generated by GSTV, that uniquely identifies this update.  This will be expected in notifications that refer to this update.
- **updatedOn** - _required_ - A UTC date and time that indicates when this update was created. This can be used to ensure updates are applied in the appropriate order. The format will be `YYYY-MM-DD HH:MM:SS.MS` using 24 hour time.
- **playlist** - _required_ - Detailed settings for playlist.
  - **siteId** - _required_ - Speedway identifier for the site.
  - **banners** - An array containing the information about playing banner static images. If this information is not present, no banners should be displayed.
    - **filename** - _If banners array exists this is required_ - Filename, including file extension, of the image to be displayed.
    - **start** - _If banners array exists this is required_ - Date the banner image should begin displaying. The format will be `YYYY-MM-DD`.
    - **end** - _If banners array exists this is required_ - Date the banner image should end displaying. The format will be `YYYY-MM-DD`.
    - **type** - _If banners array exists this is required_ - Specifies in which part of the fueling transaction the image should display.
      - Values
        - prefueling
        - postfueling
  - **schedules** - _required_ - Contains the playlist details broken up by date.
    - **segmentId** - _required_ - A unique identifier provided by GSTV for each date of the playlist. We will expect this in notifications related to this date of the playlist.
    - **date** - _required_ - A String that specifies the date the playlist is active.  The format will be `YYYY-MM-DD`.
    - **loops** - _required_ - An array that contains all the loops to be played for the day.
      - **loopNumber** - _required_ - Specifies the order in which this loop should be played in the sequence of loops. Each day will have multiple loops. Each loop should be played sequentially and repeated once the last loop has been played.
      - **assets** - _required_ - An array that specifies all the assets to be played in this loop.
        - **assetId** - _required_ - A string assigned to the media asset by GSTV. This identifier should be included in the ProofofPlay packet coming from Invenco to GSTV.
        - **filename** - _required_ - Filename of the video to be played.
        - **type** - _required_ - The type of video.
          - Values
            - advertising
            - programming
            - brandedMessaging
            - rpa
        - **start** - _required_ - Date the video should begin playing. The format will be `YYYY-MM-DD`.
        - **end** - _required_ - Date the video should end displaying. The format will be `YYYY-MM-DD`.
        - **tiNumber** - This value is internal to GSTV. This value needs to be passed back to GSTV on the ProofofPlayPacket.
        - **dayparts** - An array that specifies specific times of the day that a video should play. If no daypart is present, the video should play without regard to time.
          - **start** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should start playing if a daypart is present.
          - **end** - _if daypart array exists this is required_ - The local time represented in HH:MM using 24 hour time that asset should stop playing if a daypart is present.
        - **coupons** - _optional_ - An array that specifies the coupon metadata. If no coupons are present the coupon functionality should be disabled.
          - **title** - _required_ - String - Coupon promotion title ex. "300 Bonus Points"
          - **detail** - _required_ - String - Coupon description ex. "with Speedy Choice Tube Nuts purchase"
          - **barcode** - _required_ - String - Coupon barcode number in UPC format (12 digit numeric)
          - **restriction** - _required_ - String - Coupon restriction ex. "Limit One Per Customer"
          - **validFrom** - _required_ - String - Coupon validity ex. "Today Only"

### Additional Fields in Invenco Responses
- **notificationType** - A string indicating the step in the update process to which this notification refers.
  - Values
    - PLAYLIST_VALIDATION
    - MEDIA_CHECK
    - PLAYLIST_PULLED_BY_TERMINAL
    - PLAYLIST_ACCEPTED_BY_TERMINAL
- **notificationTimestamp** - A date and time (in UTC) that indicates when this notification was created. This can be used to ensure notifications are read in the appropriate order. The format will be `year-month-day hours:mins:secs.milliseconds` using 24 hour time.
- **status** - A String that will indicate if the step in the update process for which this notification was generated succeeded or failed.
  - Values
    - success
    - failure
- **id** - A unique identifier for this notification, generated by Invenco, that will be used to refer to the notification in human communication.
- **additionalInformation** - A free-form String that can be a message or other details about the notification.  This should be human-readable.
- **segmentIds** - An array of segment ids from the playlist that are related to this notification.
- **terminalId** - The id of the terminal at the site.

## Ideal Path
### What GSTV Sends to Invenco
```javascript
{
  "guid": String,
  "updatedOn": String,
  "playlist": [
    {
      "siteId": String,
      "banners": [
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        },
        {
          "filename": String,
          "start": String,
          "end": String,
          "type": String
        }
      ],
      "schedules": [
        {
          "segmentId": String,
          "date": String,
          "loops": [
            {
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    },
                    {
                      "start": String,
                      "end": String
                    }
                  ],
                  "coupons": [
                    {
                      "title": String,
                      "detail": String,
                      "barcode": String,
                      "restriction": String,
                      "validFrom": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": [
                    {
                      "start": String,
                      "end": String
                    }
                  ]
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "start": String,
                  "end": String,
                  "tiNumber": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            },
            {
              "loopNumber": Number,
              "assets": [
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                },
                {
                  "filename": String,
                  "type": String,
                  "dayparts": []
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

[What GSTV Sends to Invenco - Example Data](samples/json/sample1.json)

### What Invenco Sends to GSTV once Playlist Updates have been Validated
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "success",
}
```

[What Invenco Sends to GSTV once Playlist Updates have been Validated - Example Data](samples/json/sample1_notification1.json)

### What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified in the Invenco Cloud
```javascript
{
  "guid": String,
  "id": String,
  "filename": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "success",
}
```

[What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified in the Invenco Cloud - Example Data](samples/json/sample1_notification2.json)

### What Invenco Sends to GSTV once Playlist Updates have been Pulled by the Terminal
```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_PULLED_BY_TERMINAL",
  "siteId": String,
  "status": "success",
	"terminalId": String
}
```

[What Invenco Sends to GSTV once Playlist Updates have been Pulled by the Terminal - Example Data](samples/json/sample1_notification3.json)

### What Invenco Sends to GSTV once Media Files Associated with the Playlist have been Verified in the Invenco Terminal
```javascript
{
  "guid": String,
  "id": String,
  "filename": String,
  "notificationTimestamp": String
  "notificationType": "MEDIA_CHECK",
  "siteId": String,
  "status": "success",
  "terminalId": String
}
```

[What Invenco Sends to GSTV once Media Files Associated with the Playlist have been Verified in the Invenco Terminal - Example Data](samples/json/sample1_notification4.json)

### What Invenco Sends to GSTV once Playlist Updates have been Accepted by the Terminal
```javascript
{
  "guid": String,
  "id": String,
  "filename": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_ACCEPTED_BY_TERMINAL",
  "siteId": String,
  "status": "success",
  "terminalId": String
}
```

[What Invenco Sends to GSTV once Playlist Updates have been Accepted by the Terminal - Example Data](samples/json/sample1_notification5.json)

## Error Path
If any part of a message causes an error the entire update will be rejected.

### What Invenco Sends if the Playlist Update Notification has Validation Errors
Follows [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_VALIDATION",
  "siteId": String,
  "status": "failure",
  "additionalInformation": ""
}
```

[What Invenco Sends if the Playlist Update Notification has Validation Errors - Example Data](samples/json/sample1_notificationfailure1.json)

#### Specific Examples
##### What Invenco Sends if the updatedOn, filename Extension, date, loopNumber, start or end in the Playlist Update Notification is not Formatted Correctly
For any of these examples follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

If the updatedOn is not formatted as `YYYY-MM-DD HH:MM:SS.MS`.

```javascript
  "additionalInformation": "Updated On is Incorrectly Formatted"
```

If the banner filename is missing an extension.

```javascript
  "additionalInformation": "Banner Filename is Missing Extension - {filename}"
```

If the date for a schedule is not formatted as YYYY-MM-DD.

```javascript
  "additionalInformation": "Schedule Date is Incorrectly Formatted"
```

If loopNumber is not a number.

```javascript
  "additionalInformation": "Loop Number is Incorrectly Formatted"
```

If an asset filename is missing an extension.

```javascript
  "additionalInformation": "Asset Filename is Missing Extension - {filename}"
```

If the start or end date is not formatted at YYYY-MM-DD.

```javascript
  "additionalInformation": "Start Date is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Date is Incorrectly Formatted for {filename}"
```

If the start or end time is not formatted at HH:MM.

```javascript
  "additionalInformation": "Start Time is Incorrectly Formatted for {filename}"
```

```javascript
  "additionalInformation": "End Time is Incorrectly Formatted for {filename}"
```

##### What Invenco Sends if the guid, updatedOn, playlist, siteId, schedules, segmentId, date, loop, loopNumber, asset, assetId, filename, type, start, end, or tiNumber in the Playlist Updated Notification is Missing
For any of these examples follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

If the guid is missing.

```javascript
  "additionalInformation": "GUID is Missing"
```

If updatedOn is missing.

```javascript
  "additionalInformation": "Updated On is Missing"
```

If the playlist array is missing or there is an empty playlist object in the array.

```javascript
  "additionalInformation": "The Playlist Structure is Missing Information"
```

If siteId is missing.

```javascript
  "additionalInformation": "Site Identifier is Missing"
```

If a banner array exists and any object in that array is missing the filename.

```javascript
  "additionalInformation": "Banner Filename is Missing"
```

If a banner array exists and any object in that array is missing the type.

```javascript
  "additionalInformation": "Banner Type is Missing for {filename}"
```

If a banner array exists and any object in that array is start or end.

```javascript
  "additionalInformation": "Banner Start Date is Missing for {filename}"
```

```javascript
  "additionalInformation": "Banner End Date is Missing for {filename}"
```

If a banner array exists and any object in that array is missing the start, end or type and the filename.

```javascript
  "additionalInformation": "Banner Structure is Missing Information"
```

If the schedules array is missing or there is an empty schedule object in the array.

```javascript
  "additionalInformation": "Schedule Structure is Missing Information"
```

If segmentId is missing.

```javascript
  "additionalInformation": "Segment ID is Missing"
```

If schedule date is missing.

```javascript
  "additionalInformation": "Segment Date is Missing"
```

If the loop array is missing or there is an empty loop object in the array.

```javascript
  "additionalInformation": "Loop Structure is Missing Information"
```

If loopNumber is missing.

```javascript
  "additionalInformation": "Loop Number is Missing"
```

If the asset array is missing or there is an empty asset object in the array.

```javascript
  "additionalInformation": "Asset Structure is Missing Information"
```

If assetId is missing.

```javascript
  "additionalInformation": "Asset ID is Missing for {filename}"
```

If an asset is missing the filename.

```javascript
  "additionalInformation": "Asset Filename is Missing"
```

If an asset is missing the type.

```javascript
  "additionalInformation": "Asset Type is Missing for {filename}"
```

If an asset is missing the start date.

```javascript
  "additionalInformation": "Asset Start Date is Missing for {filename}"
```

If an asset is missing the end date.

```javascript
  "additionalInformation": "Asset End Date is Missing for {filename}"
```

If an asset is missing the assetId, type, start date or end date and the asset is missing a filename.

```javascript
  "additionalInformation": "Asset Information is Missing"
```

If a daypart array exists and any object in that array is missing the start.

```javascript
  "additionalInformation": "Asset Daypart Start Time is Missing for {filename}"
```

If a daypart array exists and any object in that array is missing the end.

```javascript
  "additionalInformation": "Asset Daypart End Time is Missing for {filename}"
```

If a daypart array exists and any object in that array is missing the start or end time and the asset is missing a filename.

```javascript
  "additionalInformation": "Asset Daypart Information is Missing"
```

If a coupon array exists and any object in that array is missing the title.

````javascript
  "additionalInformation": "Coupon Title is Missing"
````

If a coupon array exists and any object in that array is missing the detail.

````javascript
  "additionalInformation": "Coupon Detail is Missing"
````

If a coupon array exists and any object in that array is missing the barcode.

````javascript
  "additionalInformation": "Coupon Barcode is Missing"
````

If a coupon array exists and any object in that array is missing the restriction.

````javascript
  "additionalInformation": "Coupon Restriction is Missing"
````

If a coupon array exists and any object in that array is missing the validFrom.

````javascript
  "additionalInformation": "Coupon Valid From is Missing"
````

##### What Invenco Sends if there is a Banner and a Start Date for an Banner Object in the Playlist Update Notification Is After the End Date
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Banner Start Date is After End Date for {filename}"
```

##### What Invenco Sends if the Start Date for an Asset in the Playlist Update Notification Is After the End Date
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Start Date is After End Date for {filename}"
```

##### What Invenco Sends if there is a Daypart and a Start Time for a Daypart Object in the Playlist Update Notification Is After the End Time
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Daypart Start Time is After End Time for {filename}"
```

##### What Invenco Sends if the Banner type in the Site Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Banner Type Does Not Exist"
```

##### What Invenco Sends if the Asset type in the Site Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Asset Type Does Not Exist"
```

##### What Invenco Sends if the siteId in the Playlist Update Notification Does Not Exist
Follow [Default Error Handling](#default-error-handling).

Return above structure with this specific value for additionalInformation.

```javascript
  "additionalInformation": "Site ID Does Not Exist"
```

### What Invenco Sends if they are Unable to Pull Playlist Update Notification at the Terminal
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_PULLED_BY_TERMINAL",
  "segmentIds": [String],
  "siteId": String,
  "status": "failure",
  "additionalInformation": "",
	"terminalId": String
}
```

[What Invenco Sends if they are Unable to Pull Playlist Update Notification at the Terminal - Example Data](samples/json/sample1_notificationfailure3.json)

### What Invenco Sends if a Playlist Update Notification is Rejected by the Terminal
Follow [Default Configuration Error Handling](#default-configuration-error-handling).

```javascript
{
  "guid": String,
  "id": String,
  "notificationTimestamp": String
  "notificationType": "PLAYLIST_ACCEPTED_BY_TERMINAL",
  "segmentIds": [String],
  "siteId": String,
  "status": "failure",
  "additionalInformation": "",
	"terminalId": String
}
```

[What Invenco Sends if a Playlist Update Notification is Rejected by the Terminal - Example Data](samples/json/sample1_notificationfailure4.json)

## Standard Operating Procedure
### Applying Playlist Updates
1. Poll for playlist update notification.
1. Validate playlist update notification.
  - **If success**
    - Follow [What Invenco Sends to GSTV once Playlist Updates have been Validated](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-validated)
  - **If failure**
    - Follow [What Invenco Sends if the Playlist Update Notification has Validation Errors](#what-invenco-sends-if-the-playlist-update-notification-has-validation-errors)
1. Verify media files associated with playlist are present in Invenco Cloud.
  - **If success**
    - Follow [What Invenco Sends to GSTV once Media Files Associated with the Playlist Updates have been Verified in Invenco Cloud](#what-invenco-sends-to-gstv-once-media-files-associated-with-the-playlist-updates-have-been-verified-in-invenco-cloud)
    - **If failure**
      - Follow [What Invenco Sends if Media File is not in Invenco Cloud](../../README.md#what-invenco-sends-if-media-file-is-not-in-invenco-cloud)
1. Terminal pulls playlist.
  - **If success**
    - Follow [What Invenco Sends to GSTV once Playlist Updates have been Pulled by the Terminal](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-pulled-by-the-terminal)
  - **If failure**
    - Follow [What Invenco Sends if they are Unable to Pull Playlist Update Notification at the Terminal](#what-invenco-sends-if-they-are-unable-to-pull-playlist-update-notification-at-the-terminal)
1. Verify media files associated with playlist are present at terminal.
  - **If success**
    - Follow [What Invenco Sends to GSTV once Media Files Associated with the Playlist have been Verified in the Invenco Terminal](#what-invenco-sends-to-gstv-once-media-files-associated-with-the-playlist-have-been-verified-in-the-invenco-terminal).
  - **If failure**
    - Follow [File Missing at Terminal](../../README.md#file-missing-at-terminal)
1. Apply playlist to terminal.
  - **If success**
    - Follow [What Invenco Sends to GSTV once Playlist Updates have been Accepted by the Terminal](#what-invenco-sends-to-gstv-once-playlist-updates-have-been-accepted-by-the-terminal)
  - **If failure**
    - Follow [What Invenco Sends if a Playlist Update Notification is Rejected by the Terminal](#what-invenco-sends-if-a-playlist-update-notification-is-rejected-by-the-terminal)
1. Commence video playback
  - If a banner is present in the playlist
    - If the current date is within the dates defined by the start and end dates
      - If the terminal has the asset
        - Display during fueling lifecycle defined by type
      - If the terminal does not have the asset
        - Do not display
    - If the current date is outside the dates defined by the start and end dates
      - Do not display
  - Using schedule date
    - If schedule date is current date
      - Play loops in order
        - If a media file is not present at the terminal skip it during playback and continue
        - If a daypart is present for an asset
          - If the current time is within the times defined by the start and end times
            - If the terminal has the asset
              - Play the asset
            - If the terminal does not have the asset
              - Do not play the asset
          - If the current time is outside the times defined by the start and end times
            - Do not play the asset
    - If schedule date is not current date
      - Do not play assets defined in that schedule object

### Error Handling
#### Playlist Error Handling
1. Send a notification message to GSTV alerting that an error has occurred.
1. Playback does not stop.
1. GSTV sends another notification update message.
